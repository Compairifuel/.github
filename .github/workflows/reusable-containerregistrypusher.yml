name: Compairifuel Automatic Push Image to Registry
description: This Action is a reusable workflow to push container images to a container registry.

on:
  workflow_call:
    inputs:
      registry:
        description: "Container registry hostname (e.g. ghcr.io, docker.io)"
        type: string
        required: true
      image_name:
        description: "Image name (e.g. my-org/my-app)"
        type: string
        required: true
      image_tag:
        description: "Image tags/versions (Comma-separated)"
        type: string
        default: "latest"
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: Dockerfile
      context:
        description: "Docker build context"
        type: string
        default: "."
      build_args:
        description: "Image Build Arguments (newline-separated)"
        type: string
        default: ""
    outputs:
      imageid:
        description: "The ImageId"
        value: ${{ jobs.build-and-push.outputs.imageid }}
      digest:
        description: "The Digest"
        value: ${{ jobs.build-and-push.outputs.digest }}
      metadata: 
        description: "The Metadata"
        value: ${{ jobs.build-and-push.outputs.metadata }}
    secrets:
      registry_username:
        description: "Registry username"
        required: true
      registry_password:
        description: "Registry password or token"
        required: true

jobs:
  build-and-push:
    outputs:
      imageid: ${{ steps.build-and-push.outputs.imageid || ''}}
      digest: ${{ steps.build-and-push.outputs.digest || ''}}
      metadata: ${{ steps.build-and-push.outputs.metadata || ''}}
    runs-on: "ubuntu-latest"
    permissions:
      contents: read
      packages: write
    steps:
      - name: Generate tags
        id: tags
        run: |
          TAGS=$(echo "${{ inputs.image_tag }}" | tr ',' '\n' | sed "s|^|${{ inputs.registry }}/${{ inputs.image_name }}:|" | sort -u)
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}

      - name: Prepare build args
        id: build_args
        shell: bash
        run: |
          BUILD_ARGS=$(echo "${{ inputs.build_args }}" | sed '/^\s*$/d' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo "$BUILD_ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push image
        id: build-and-push
        uses: docker/build-push-action@v6
        with:
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cache-from: type=registry,ref=${{ inputs.registry }}/${{ inputs.image_name }}:cache
          cache-to: type=registry,ref=${{ inputs.registry }}/${{ inputs.image_name }}:cache,mode=max
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: ${{ steps.build_args.outputs.build_args }}
          provenance: false
          pull: true
          platforms: linux/amd64,linux/arm64